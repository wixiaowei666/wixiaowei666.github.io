<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>萌宠管家 - AI宠物健康管理平台</title>
  <!-- 引入iconfont图标库（阿里图标库公共库，包含宠物相关图标） -->
  <link rel="stylesheet" href="//at.alicdn.com/t/c/font_4608790_9z0e8k8h87.css">
  <!-- 本地Bootstrap CSS -->
  <link href="./bootstrap-5.3.0-alpha1-dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- 本地Bootstrap Icons -->
  <link rel="stylesheet" href="./bootstrap-icons.min.css">
  <!-- 本地jQuery -->
  <script src="./jquery.min.js"></script>
  <!-- 本地Bootstrap JS -->
  <script src="./bootstrap-5.3.0-alpha1-dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* 自定义样式 - 优化视觉和交互 */
    :root {
      --primary-color: #dcc2e5; /* 主题色 */
      --primary-dark: #c9a5d6; /* 主题色加深（hover/active） */
      --primary-text: #6a4b7b; /* 主题色配套文字色 */
    }
    body {
      min-height: 100vh;
      background-color: #faf7fb; /* 浅紫背景适配主题色 */
      font-family: "Microsoft YaHei", sans-serif; /* 适配中文显示 */
      color: #555;
    }
    /* 顶部导航栏主题色 */
    .header {
      background-color: var(--primary-color);
      color: var(--primary-text);
      padding: 1rem 0;
      box-shadow: 0 2px 8px rgba(220, 194, 229, 0.4); /* 主题色阴影 */
    }
    .nav-link {
      color: var(--primary-text) !important;
      font-size: 16px;
      margin: 0 8px;
      cursor: pointer;
      transition: all 0.3s ease; /* 平滑过渡 */
      font-weight: 500;
    }
    .nav-link.active {
      font-weight: bold;
      border-bottom: 2px solid var(--primary-text);
      color: var(--primary-text) !important;
    }
    .nav-link:hover {
      color: #5a3d69 !important;
      transform: translateY(-1px); /* 悬浮微抬 */
    }
    /* 卡片样式优化 */
    .function-card {
      max-width: 1000px;
      margin: 2rem auto;
      box-shadow: 0 0 20px rgba(220, 194, 229, 0.2); /* 主题色阴影 */
      border-radius: 12px; /* 圆角更柔和 */
      overflow: hidden;
      border: 1px solid var(--primary-color); /* 主题色边框 */
      background-color: #fff;
    }
    .card-header {
      background-color: var(--primary-color) !important;
      border-bottom: 1px solid var(--primary-dark) !important;
      color: var(--primary-text);
      font-weight: 600;
    }
    /* 按钮主题色 */
    .submit-btn {
      width: 100%;
      height: 48px;
      font-size: 16px;
      border-radius: 8px; /* 按钮圆角 */
      font-weight: 500;
      transition: all 0.3s ease;
      background-color: var(--primary-color) !important;
      border-color: var(--primary-color) !important;
      color: var(--primary-text) !important;
    }
    .submit-btn:hover {
      background-color: var(--primary-dark) !important;
      border-color: var(--primary-dark) !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(220, 194, 229, 0.5);
    }
    .submit-btn:disabled {
      background-color: #e8dcf0 !important;
      border-color: #e8dcf0 !important;
      cursor: not-allowed;
    }
    /* 表单控件优化 */
    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid var(--primary-color); /* 主题色边框 */
      padding: 0.6rem 0.8rem;
      transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-dark); /* 主题色加深 */
      box-shadow: 0 0 0 3px rgba(220, 194, 229, 0.2); /* 主题色聚焦阴影 */
      outline: none;
    }
    /* 图标样式 */
    .iconfont {
      font-size: 1.2rem;
      margin-right: 8px;
    }
    .module-icon {
      font-size: 1.5rem;
      margin-right: 10px;
    }
    /* 隐藏所有功能模块，通过Tab切换显示 */
    .function-tab {
      display: none;
    }
    .function-tab.active {
      display: block;
      animation: fadeIn 0.5s ease; /* 切换淡入动画 */
    }
    /* 加载中状态优化 */
    .spinner-border {
      position: relative;
      top: 2px;
      color: var(--primary-text) !important;
    }
    .result-content {
      line-height: 1.8;
      font-size: 14px;
      color: #555;
      white-space: pre-wrap; /* 保留AI返回的换行 */
    }
    /* 响应式适配增强 */
    @media (max-width: 768px) {
      .function-card {
        margin: 1rem;
      }
      .header {
        padding: 0.8rem 0;
      }
      .nav-link {
        font-size: 14px;
        margin: 0 4px;
      }
    }
    /* 淡入动画 */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    /* 页脚固定底部 */
    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: var(--primary-color);
      border-top: 1px solid var(--primary-dark);
      color: var(--primary-text);
      padding: 0.8rem 0;
    }
    /* 主内容区适配底部页脚 */
    main {
      padding-bottom: 80px; /* 避免内容被页脚遮挡 */
    }
    /* 档案卡片样式优化 */
    .card {
      border: 1px solid var(--primary-color) !important;
    }
    .card-header.bg-white {
      background-color: #faf7fb !important;
      border-bottom: 1px solid var(--primary-color) !important;
    }
    .text-primary {
      color: var(--primary-text) !important;
    }
  </style>
</head>
<body>
  <!-- 顶部导航 -->
  <header class="header">
    <div class="container">
      <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
          <a class="navbar-brand fw-bold" href="#">
            <i class="iconfont icon-chongwu module-icon"></i> 萌宠管家
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a class="nav-link active" id="tab-diagnose" onclick="switchTab('diagnose')">
                  <i class="iconfont icon-yisheng"></i> AI智能问诊
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="tab-diet" onclick="switchTab('diet')">
                  <i class="iconfont icon-shicai"></i> 个性化饮食规划
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="tab-record" onclick="switchTab('record')">
                  <i class="iconfont icon-dangan"></i> 宠物健康档案
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="tab-behavior" onclick="switchTab('behavior')">
                  <i class="iconfont icon-xingwei"></i> 行为解读助手
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <!-- 核心功能区域 -->
  <main class="container">
    <div class="card function-card">
      <!-- 1. AI智能问诊模块 -->
      <div class="function-tab active" id="diagnose-tab">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-bold">
            <i class="iconfont icon-yisheng module-icon"></i> AI萌宠智能问诊
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="row mb-4 g-3">
            <div class="col-md-4">
              <label for="breed" class="form-label fw-medium">
                <i class="iconfont icon-chongwu1"></i> 宠物品种
              </label>
              <input type="text" class="form-control" id="breed" placeholder="如：金毛、布偶猫、柯基">
            </div>
            <div class="col-md-4">
              <label for="age" class="form-label fw-medium">
                <i class="iconfont icon-nianling"></i> 宠物年龄
              </label>
              <input type="text" class="form-control" id="age" placeholder="如：2岁、6个月">
            </div>
            <div class="col-md-4">
              <label for="weight" class="form-label fw-medium">
                <i class="iconfont icon-tizhong"></i> 体重(kg)
              </label>
              <input type="number" class="form-control" id="weight" placeholder="如：10、4.5" step="0.1">
            </div>
          </div>
          <div class="mb-4">
            <label for="symptom" class="form-label fw-medium">
              <i class="iconfont icon-zhengzhuang"></i> 症状描述
            </label>
            <textarea class="form-control" id="symptom" rows="5" placeholder="请详细描述宠物的异常症状，例如：呕吐、腹泻、精神不振、皮肤瘙痒、掉毛等"></textarea>
          </div>
          <button id="diagnoseBtn" class="btn btn-primary submit-btn" onclick="submitDiagnose()">
            <span id="diagnoseBtnText">
              <i class="iconfont icon-fenxi"></i> AI分析症状
            </span>
            <div id="diagnoseSpinner" class="spinner-border spinner-border-sm d-none" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </button>
          <hr class="my-4">
          <h6 class="fw-bold">
            <i class="iconfont icon-jieguo"></i> AI诊断结果
          </h6>
          <div id="diagnoseResult" class="card mt-2 d-none">
            <div class="card-body result-content p-3" id="diagnoseResultContent"></div>
          </div>
        </div>
      </div>

      <!-- 2. 个性化饮食规划模块 -->
      <div class="function-tab" id="diet-tab">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-bold">
            <i class="iconfont icon-shicai module-icon"></i> 个性化饮食规划
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="row mb-4 g-3">
            <div class="col-md-4">
              <label for="dietBreed" class="form-label fw-medium">
                <i class="iconfont icon-chongwu1"></i> 宠物品种
              </label>
              <input type="text" class="form-control" id="dietBreed" placeholder="如：金毛、布偶猫、柯基">
            </div>
            <div class="col-md-4">
              <label for="dietAge" class="form-label fw-medium">
                <i class="iconfont icon-nianling"></i> 宠物年龄
              </label>
              <input type="text" class="form-control" id="dietAge" placeholder="如：2岁、6个月">
            </div>
            <div class="col-md-4">
              <label for="dietHealth" class="form-label fw-medium">
                <i class="iconfont icon-jiankang"></i> 健康状况
              </label>
              <select class="form-select" id="dietHealth">
                <option value="健康">健康</option>
                <option value="肥胖">肥胖</option>
                <option value="偏瘦">偏瘦</option>
                <option value="糖尿病">糖尿病</option>
                <option value="肠胃敏感">肠胃敏感</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label for="dietPreference" class="form-label fw-medium">
              <i class="iconfont icon-pianhao"></i> 饮食偏好/禁忌
            </label>
            <textarea class="form-control" id="dietPreference" rows="3" placeholder="例如：不吃鸡肉、对谷物过敏、喜欢吃鱼等"></textarea>
          </div>
          <button id="dietBtn" class="btn btn-success submit-btn" onclick="submitDiet()">
            <span id="dietBtnText">
              <i class="iconfont icon-shejihua"></i> 生成饮食方案
            </span>
            <div id="dietSpinner" class="spinner-border spinner-border-sm d-none" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </button>
          <hr class="my-4">
          <h6 class="fw-bold">
            <i class="iconfont icon-fangan"></i> AI定制饮食方案
          </h6>
          <div id="dietResult" class="card mt-2 d-none">
            <div class="card-body result-content p-3" id="dietResultContent"></div>
          </div>
        </div>
      </div>

      <!-- 3. 宠物健康档案模块 -->
      <div class="function-tab" id="record-tab">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-bold">
            <i class="iconfont icon-dangan module-icon"></i> 宠物健康档案
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="row mb-4 g-3">
            <div class="col-md-6">
              <label for="recordName" class="form-label fw-medium">
                <i class="iconfont icon-nicheng"></i> 宠物昵称
              </label>
              <input type="text" class="form-control" id="recordName" placeholder="如：旺财、咪咪">
            </div>
            <div class="col-md-6">
              <label for="recordBreed" class="form-label fw-medium">
                <i class="iconfont icon-chongwu1"></i> 宠物品种
              </label>
              <input type="text" class="form-control" id="recordBreed" placeholder="如：金毛、布偶猫、柯基">
            </div>
          </div>
          <div class="row mb-4 g-3">
            <div class="col-md-4">
              <label for="recordVaccine" class="form-label fw-medium">
                <i class="iconfont icon-yimiao"></i> 疫苗接种日期
              </label>
              <input type="date" class="form-control" id="recordVaccine">
            </div>
            <div class="col-md-4">
              <label for="recordDeworm" class="form-label fw-medium">
                <i class="iconfont icon-quchong"></i> 驱虫日期
              </label>
              <input type="date" class="form-control" id="recordDeworm">
            </div>
            <div class="col-md-4">
              <label for="recordCheckup" class="form-label fw-medium">
                <i class="iconfont icon-tijian"></i> 体检日期
              </label>
              <input type="date" class="form-control" id="recordCheckup">
            </div>
          </div>
          <div class="mb-4">
            <label for="recordNote" class="form-label fw-medium">
              <i class="iconfont icon-beizhu"></i> 健康备注
            </label>
            <textarea class="form-control" id="recordNote" rows="3" placeholder="例如：2025年1月体检发现牙结石，建议洁牙"></textarea>
          </div>
          <button class="btn btn-info submit-btn mb-4" onclick="saveRecord()">
            <i class="iconfont icon-baocun"></i> 保存健康档案
          </button>
          <h6 class="fw-bold">
            <i class="iconfont icon-liebiao"></i> 档案列表
          </h6>
          <div class="card mt-2">
            <div class="card-body p-3">
              <div id="recordList" class="result-content">暂无健康档案，点击上方按钮添加</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. 行为解读助手模块 -->
      <div class="function-tab" id="behavior-tab">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0 fw-bold">
            <i class="iconfont icon-xingwei module-icon"></i> 行为解读助手
          </h5>
        </div>
        <div class="card-body p-4">
          <div class="row mb-4 g-3">
            <div class="col-md-4">
              <label for="behaviorBreed" class="form-label fw-medium">
                <i class="iconfont icon-chongwu1"></i> 宠物品种
              </label>
              <input type="text" class="form-control" id="behaviorBreed" placeholder="如：金毛、布偶猫、柯基">
            </div>
            <div class="col-md-4">
              <label for="behaviorAge" class="form-label fw-medium">
                <i class="iconfont icon-nianling"></i> 宠物年龄
              </label>
              <input type="text" class="form-control" id="behaviorAge" placeholder="如：2岁、6个月">
            </div>
            <div class="col-md-4">
              <label for="behaviorType" class="form-label fw-medium">
                <i class="iconfont icon-xingwei1"></i> 行为类型
              </label>
              <select class="form-select" id="behaviorType">
                <option value="乱尿/乱拉">乱尿/乱拉</option>
                <option value="拆家/啃咬">拆家/啃咬</option>
                <option value="过度吠叫/叫春">过度吠叫/叫春</option>
                <option value="攻击行为">攻击行为</option>
                <option value="其他">其他</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label for="behaviorDesc" class="form-label fw-medium">
              <i class="iconfont icon-miaoshu"></i> 行为详细描述
            </label>
            <textarea class="form-control" id="behaviorDesc" rows="5" placeholder="例如：每天凌晨3点开始叫，持续1小时；在家乱咬沙发，只咬客厅的布艺沙发"></textarea>
          </div>
          <button id="behaviorBtn" class="btn btn-warning submit-btn" onclick="submitBehavior()">
            <span id="behaviorBtnText">
              <i class="iconfont icon-jiedu"></i> 解读行为原因
            </span>
            <div id="behaviorSpinner" class="spinner-border spinner-border-sm d-none" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </button>
          <hr class="my-4">
          <h6 class="fw-bold">
            <i class="iconfont icon-jieguo"></i> AI行为解读结果
          </h6>
          <div id="behaviorResult" class="card mt-2 d-none">
            <div class="card-body result-content p-3" id="behaviorResultContent"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="mt-auto">
    <div class="container text-center">
      <i class="iconfont icon-chongwu"></i> 萌宠管家 ©2025 - AI驱动的宠物健康管理平台 | 传智杯参赛作品
    </div>
  </footer>

  <script>
    // 你的API Key（已保留，无需修改）
    const API_KEY = 'sk-627e5aea1db74270beb7e14ed41bd5ec'; 
    const API_URL = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';

    // 1. 切换标签页功能 - 优化兼容性
    function switchTab(tabName) {
      $('.function-tab').removeClass('active');
      $(`#${tabName}-tab`).addClass('active');
      $('.nav-link').removeClass('active');
      $(`#tab-${tabName}`).addClass('active');
      // 滚动到顶部（移动端友好）
      $('html, body').animate({scrollTop: $('.function-card').offset().top - 20}, 300);
    }

    // 2. AI智能问诊提交 - 增强容错
    function submitDiagnose() {
      const breed = $('#breed').val().trim() || '未知品种'; // 兜底默认值
      const age = $('#age').val().trim() || '未知年龄';
      const weight = $('#weight').val().trim() || '未知体重';
      const symptom = $('#symptom').val().trim();

      if (!symptom) { // 只强制校验核心字段
        alert('请详细描述宠物的异常症状！');
        return;
      }

      // 加载状态
      $('#diagnoseBtnText').addClass('d-none');
      $('#diagnoseSpinner').removeClass('d-none');
      $('#diagnoseBtn').attr('disabled', true);

      const requestData = {
        model: 'qwen-turbo',
        messages: [
          { role: 'system', content: '你是资深宠物医生，分析猫狗健康问题，回答通俗易懂，分点说明可能问题、护理建议、就医提示。语言风格亲切，适合宠物主人理解。' },
          { role: 'user', content: `宠物品种：${breed}，年龄：${age}，体重：${weight}kg，症状：${symptom}。按1.可能的健康问题（概率排序）；2.家庭护理建议；3.需立即就医的情况回答。` }
        ],
        temperature: 0.7,
        max_tokens: 1000
      };

      callAIApi(requestData, 'diagnose');
    }

    // 3. 个性化饮食规划提交
    function submitDiet() {
      const breed = $('#dietBreed').val().trim() || '未知品种';
      const age = $('#dietAge').val().trim() || '未知年龄';
      const health = $('#dietHealth').val();
      const preference = $('#dietPreference').val().trim() || '无特殊偏好/禁忌';

      // 加载状态
      $('#dietBtnText').addClass('d-none');
      $('#dietSpinner').removeClass('d-none');
      $('#dietBtn').attr('disabled', true);

      const requestData = {
        model: 'qwen-turbo',
        messages: [
          { role: 'system', content: '你是宠物营养师，为不同品种/年龄/健康状况的宠物定制每日饮食方案，回答通俗易懂，分早餐/午餐/晚餐，注明食材和用量，语言亲切。' },
          { role: 'user', content: `宠物品种：${breed}，年龄：${age}，健康状况：${health}，饮食偏好/禁忌：${preference}。为它定制一份详细的每日饮食方案，分餐次说明食材、用量、注意事项。` }
        ],
        temperature: 0.7,
        max_tokens: 1000
      };

      callAIApi(requestData, 'diet');
    }

    // 4. 行为解读助手提交
    function submitBehavior() {
      const breed = $('#behaviorBreed').val().trim() || '未知品种';
      const age = $('#behaviorAge').val().trim() || '未知年龄';
      const type = $('#behaviorType').val();
      const desc = $('#behaviorDesc').val().trim();

      if (!desc) {
        alert('请详细描述宠物的异常行为！');
        return;
      }

      // 加载状态
      $('#behaviorBtnText').addClass('d-none');
      $('#behaviorSpinner').removeClass('d-none');
      $('#behaviorBtn').attr('disabled', true);

      const requestData = {
        model: 'qwen-turbo',
        messages: [
          { 
            role: 'system', 
            content: '你是资深宠物行为学专家，擅长解读猫狗的异常行为。回答要求：1. 原因分析（通俗易懂，避免专业术语）；2. 具体可操作的纠正方法；3. 注意事项。分点说明，语言亲切，每点不超过200字。' 
          },
          { 
            role: 'user', 
            content: `宠物品种：${breed}，年龄：${age}，行为类型：${type}，行为详细描述：${desc}。请按上述要求分析并给出建议。` 
          }
        ],
        temperature: 0.7,
        max_tokens: 1000
      };

      callAIApi(requestData, 'behavior');
    }

    // 5. 保存健康档案 - 优化体验
    function saveRecord() {
      const name = $('#recordName').val().trim();
      const breed = $('#recordBreed').val().trim();
      const vaccine = $('#recordVaccine').val() || '未填写';
      const deworm = $('#recordDeworm').val() || '未填写';
      const checkup = $('#recordCheckup').val() || '未填写';
      const note = $('#recordNote').val().trim() || '无';

      if (!name || !breed) {
        alert('请填写宠物昵称和品种！');
        return;
      }

      const record = {
        name, breed, vaccine, deworm, checkup, note,
        createTime: new Date().toLocaleString() // 精确到时分秒
      };

      let records = JSON.parse(localStorage.getItem('petRecords')) || [];
      records.push(record);
      localStorage.setItem('petRecords', JSON.stringify(records));

      renderRecordList(records);
      // 清空表单
      $('#recordName, #recordBreed, #recordVaccine, #recordDeworm, #recordCheckup, #recordNote').val('');
      alert('健康档案保存成功！');
    }

    // 6. 渲染健康档案列表 - 优化样式
    function renderRecordList(records) {
      if (records.length === 0) {
        $('#recordList').html('<div class="text-muted text-center py-3">暂无健康档案，点击上方按钮添加</div>');
        return;
      }

      let html = '';
      records.forEach((item, index) => {
        html += `
          <div class="card mb-3 border-light shadow-sm">
            <div class="card-header py-2 bg-white d-flex justify-content-between align-items-center">
              <span class="fw-bold text-primary">${item.name}（${item.breed}）</span>
              <span class="text-muted small">添加时间：${item.createTime}</span>
            </div>
            <div class="card-body py-2">
              <div class="row">
                <div class="col-md-4"><small class="text-muted">疫苗接种：</small>${item.vaccine}</div>
                <div class="col-md-4"><small class="text-muted">驱虫日期：</small>${item.deworm}</div>
                <div class="col-md-4"><small class="text-muted">体检日期：</small>${item.checkup}</div>
              </div>
              <div class="mt-2"><small class="text-muted">健康备注：</small>${item.note}</div>
            </div>
          </div>
        `;
      });
      $('#recordList').html(html);
    }

    // 7. 通用AI接口调用 - 移除API Key校验
    function callAIApi(requestData, type) {
      $.ajax({
        url: API_URL,
        type: 'POST',
        contentType: 'application/json',
        headers: { 'Authorization': `Bearer ${API_KEY}` },
        data: JSON.stringify(requestData),
        timeout: 20000, // 延长超时时间到20秒
        success: function(response) {
          if (response.choices && response.choices.length > 0) {
            const aiResult = response.choices[0].message.content;
            // 格式化结果，增强可读性
            const formattedResult = aiResult
              .replace(/\n+/g, '<br>')
              .replace(/1\. /g, '<br><strong class="text-primary">1. </strong>')
              .replace(/2\. /g, '<br><strong class="text-primary">2. </strong>')
              .replace(/3\. /g, '<br><strong class="text-primary">3. </strong>');
            
            // 显示结果
            $(`#${type}ResultContent`).html(formattedResult);
            $(`#${type}Result`).removeClass('d-none');
            // 滚动到结果区域
            $(`#${type}Result`)[0]?.scrollIntoView({behavior: 'smooth', block: 'nearest'});
          } else {
            alert('AI返回结果为空，请重试！');
          }
        },
        error: function(xhr, status, error) {
          let errorMsg = 'AI请求失败！';
          if (xhr.status === 401) errorMsg = 'API Key无效或未实名认证！';
          else if (xhr.status === 429) errorMsg = 'API调用次数超限（免费额度用完）！';
          else if (status === 'timeout') errorMsg = '请求超时，请检查网络或稍后重试！';
          else if (xhr.status === 0) errorMsg = '跨域问题！请用VS Code的Live Server运行页面！';
          else errorMsg += `（错误码：${xhr.status}）`;
          
          alert(errorMsg);
          console.error(`【${type}模块错误】`, xhr, status, error);
        },
        complete: function() {
          // 恢复按钮状态
          resetButtonStatus(type);
        }
      });
    }

    // 重置按钮状态（通用函数）
    function resetButtonStatus(type) {
      $(`#${type}BtnText`).removeClass('d-none');
      $(`#${type}Spinner`).addClass('d-none');
      $(`#${type}Btn`).attr('disabled', false);
    }

    // 页面加载初始化
    $(document).ready(function() {
      // 渲染健康档案
      const records = JSON.parse(localStorage.getItem('petRecords')) || [];
      renderRecordList(records);
      
      // 移动端导航折叠优化
      $('.navbar-toggler').click(function() {
        $('.navbar-collapse').toggleClass('show');
      });
      
      // 点击空白处关闭移动端导航
      $(document).click(function(e) {
        if (!$(e.target).closest('.navbar').length) {
          $('.navbar-collapse').removeClass('show');
        }
      });
    });
  </script>
</body>
</html>